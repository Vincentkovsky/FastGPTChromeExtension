(()=>{"use strict";class e{async getEncryptionKey(){const t=(chrome.runtime.id||"default-id")+e.SALT,s=new TextEncoder,n=s.encode(t),a=await crypto.subtle.importKey("raw",n,{name:"PBKDF2"},!1,["deriveKey"]);return crypto.subtle.deriveKey({name:"PBKDF2",salt:s.encode(e.SALT),iterations:1e5,hash:"SHA-256"},a,{name:e.ALGORITHM,length:e.KEY_LENGTH},!1,["encrypt","decrypt"])}async encrypt(t){try{const s=(new TextEncoder).encode(t),n=await this.getEncryptionKey(),a=crypto.getRandomValues(new Uint8Array(e.IV_LENGTH)),r=await crypto.subtle.encrypt({name:e.ALGORITHM,iv:a},n,s),o=new Uint8Array(a.length+r.byteLength);return o.set(a),o.set(new Uint8Array(r),a.length),btoa(String.fromCharCode(...o))}catch(e){throw new Error(`Encryption failed: ${e instanceof Error?e.message:"Unknown error"}`)}}async decrypt(t){try{const s=new Uint8Array(atob(t).split("").map(e=>e.charCodeAt(0))),n=s.slice(0,e.IV_LENGTH),a=s.slice(e.IV_LENGTH),r=await this.getEncryptionKey(),o=await crypto.subtle.decrypt({name:e.ALGORITHM,iv:n},r,a);return(new TextDecoder).decode(o)}catch(e){throw new Error(`Decryption failed: ${e instanceof Error?e.message:"Unknown error"}`)}}}e.ALGORITHM="AES-GCM",e.KEY_LENGTH=256,e.IV_LENGTH=12,e.SALT="fastgpt-chrome-ext-salt";class t{constructor(t){this.encryptionService=t||new e}async setFastGPTConfig(e){try{const t=await this.encryptionService.encrypt(e.apiKey),s={fastgptConfig:{baseUrl:e.baseUrl,appId:e.appId,apiKey:t}};return await this.setStorageData(s),{success:!0}}catch(e){return{success:!1,error:`Failed to store FastGPT config: ${e instanceof Error?e.message:"Unknown error"}`}}}async getFastGPTConfig(){try{const e=await this.getStorageData(["fastgptConfig"]);if(!e.fastgptConfig)return{success:!0,data:null};const t=await this.encryptionService.decrypt(e.fastgptConfig.apiKey);return{success:!0,data:{baseUrl:e.fastgptConfig.baseUrl,appId:e.fastgptConfig.appId,apiKey:t}}}catch(e){return{success:!1,error:`Failed to retrieve FastGPT config: ${e instanceof Error?e.message:"Unknown error"}`}}}async setSetupState(e,t){try{const s={setupState:{onboardingComplete:e,configurationComplete:t}};return await this.setStorageData(s),{success:!0}}catch(e){return{success:!1,error:`Failed to store setup state: ${e instanceof Error?e.message:"Unknown error"}`}}}async getSetupState(){try{const e=await this.getStorageData(["setupState"]),t={onboardingComplete:!1,configurationComplete:!1};return{success:!0,data:e.setupState||t}}catch(e){return{success:!1,error:`Failed to retrieve setup state: ${e instanceof Error?e.message:"Unknown error"}`}}}async setChatSession(e,t){try{const s=await this.getChatSessions(),n=s.success&&s.data||{};n[e]={messages:t.messages,createdAt:t.createdAt.toISOString(),updatedAt:t.updatedAt.toISOString()};const a={chatSessions:n};return await this.setStorageData(a),{success:!0}}catch(e){return{success:!1,error:`Failed to store chat session: ${e instanceof Error?e.message:"Unknown error"}`}}}async getChatSessions(){try{return{success:!0,data:(await this.getStorageData(["chatSessions"])).chatSessions||null}}catch(e){return{success:!1,error:`Failed to retrieve chat sessions: ${e instanceof Error?e.message:"Unknown error"}`}}}async setChatSessions(e){try{const t={chatSessions:e};return await this.setStorageData(t),{success:!0}}catch(e){return{success:!1,error:`Failed to set chat sessions: ${e instanceof Error?e.message:"Unknown error"}`}}}async setPreferences(e){try{const t={preferences:e};return await this.setStorageData(t),{success:!0}}catch(e){return{success:!1,error:`Failed to store preferences: ${e instanceof Error?e.message:"Unknown error"}`}}}async getPreferences(){try{const e=await this.getStorageData(["preferences"]),t={streamingEnabled:!0};return{success:!0,data:e.preferences||t}}catch(e){return{success:!1,error:`Failed to retrieve preferences: ${e instanceof Error?e.message:"Unknown error"}`}}}async getExtensionState(){try{const e=await this.getSetupState(),t=await this.getFastGPTConfig();if(!e.success)return{success:!1,error:e.error};const s=e.data;let n="onboarding";return s.onboardingComplete&&!s.configurationComplete?n="configuration":s.onboardingComplete&&s.configurationComplete&&(n="chat"),{success:!0,data:{setupComplete:s.onboardingComplete,configurationComplete:s.configurationComplete,currentView:n,fastgptConfig:t.success&&t.data||void 0}}}catch(e){return{success:!1,error:`Failed to get extension state: ${e instanceof Error?e.message:"Unknown error"}`}}}async clearAllData(){try{return await new Promise((e,t)=>{chrome.storage.local.clear(()=>{chrome.runtime.lastError?t(new Error(chrome.runtime.lastError.message)):e()})}),{success:!0}}catch(e){return{success:!1,error:`Failed to clear data: ${e instanceof Error?e.message:"Unknown error"}`}}}async removeData(e){try{return await new Promise((t,s)=>{chrome.storage.local.remove(e,()=>{chrome.runtime.lastError?s(new Error(chrome.runtime.lastError.message)):t()})}),{success:!0}}catch(e){return{success:!1,error:`Failed to remove data: ${e instanceof Error?e.message:"Unknown error"}`}}}async setStorageData(e){return new Promise((t,s)=>{chrome.storage.local.set(e,()=>{chrome.runtime.lastError?s(new Error(chrome.runtime.lastError.message)):t()})})}async getStorageData(e){return new Promise((t,s)=>{chrome.storage.local.get(e,e=>{chrome.runtime.lastError?s(new Error(chrome.runtime.lastError.message)):t(e)})})}}class s{constructor(e){this.currentState=null,this.stateChangeListeners=[],this.storageManager=e||new t}async initialize(){const e=await this.loadState();return e.success&&e.data&&(this.currentState=e.data),e}getCurrentState(){return this.currentState}async loadState(){try{const e=await this.storageManager.getExtensionState();return e.success&&e.data&&(this.currentState=e.data,this.notifyStateChange(e.data)),e}catch(e){return{success:!1,error:`Failed to load state: ${e instanceof Error?e.message:"Unknown error"}`}}}async completeOnboarding(){try{const e=await this.storageManager.getSetupState();if(!e.success)return{success:!1,error:e.error};const t=e.data,s=await this.storageManager.setSetupState(!0,t.configurationComplete);return s.success?await this.refreshState():{success:!1,error:s.error}}catch(e){return{success:!1,error:`Failed to complete onboarding: ${e instanceof Error?e.message:"Unknown error"}`}}}async completeConfiguration(e){try{const t=await this.storageManager.setFastGPTConfig(e);if(!t.success)return{success:!1,error:t.error};const s=await this.storageManager.getSetupState();if(!s.success)return{success:!1,error:s.error};const n=s.data,a=await this.storageManager.setSetupState(n.onboardingComplete,!0);return a.success?await this.refreshState():{success:!1,error:a.error}}catch(e){return{success:!1,error:`Failed to complete configuration: ${e instanceof Error?e.message:"Unknown error"}`}}}async resetOnboarding(){try{const e=await this.storageManager.getSetupState();if(!e.success)return{success:!1,error:e.error};const t=e.data,s=await this.storageManager.setSetupState(!1,t.configurationComplete);return s.success?await this.refreshState():{success:!1,error:s.error}}catch(e){return{success:!1,error:`Failed to reset onboarding: ${e instanceof Error?e.message:"Unknown error"}`}}}async resetConfiguration(){try{const e=await this.storageManager.removeData(["fastgptConfig"]);if(!e.success)return{success:!1,error:e.error};const t=await this.storageManager.getSetupState();if(!t.success)return{success:!1,error:t.error};const s=t.data,n=await this.storageManager.setSetupState(s.onboardingComplete,!1);return n.success?await this.refreshState():{success:!1,error:n.error}}catch(e){return{success:!1,error:`Failed to reset configuration: ${e instanceof Error?e.message:"Unknown error"}`}}}async resetAllState(){try{const e=await this.storageManager.clearAllData();return e.success?await this.refreshState():{success:!1,error:e.error}}catch(e){return{success:!1,error:`Failed to reset all state: ${e instanceof Error?e.message:"Unknown error"}`}}}isReadyForChat(){return!0===this.currentState?.setupComplete&&!0===this.currentState?.configurationComplete}isOnboardingComplete(){return!0===this.currentState?.setupComplete}isConfigurationComplete(){return!0===this.currentState?.configurationComplete}getCurrentView(){return this.currentState?.currentView||"onboarding"}addStateChangeListener(e){this.stateChangeListeners.push(e)}removeStateChangeListener(e){const t=this.stateChangeListeners.indexOf(e);t>-1&&this.stateChangeListeners.splice(t,1)}canTransitionTo(e){switch(this.getCurrentView(),e){case"onboarding":return!0;case"configuration":return this.isOnboardingComplete();case"chat":return this.isOnboardingComplete()&&this.isConfigurationComplete();default:return!1}}async forceTransitionTo(e){return this.canTransitionTo(e)?(this.currentState&&(this.currentState.currentView=e,this.notifyStateChange(this.currentState)),{success:!0,data:this.currentState}):{success:!1,error:`Invalid state transition from ${this.getCurrentView()} to ${e}`}}getFastGPTConfig(){return this.currentState?.fastgptConfig||null}async setCurrentView(e){return this.canTransitionTo(e)?(this.currentState&&(this.currentState.currentView=e,this.notifyStateChange(this.currentState)),{success:!0,data:this.currentState}):{success:!1,error:`Invalid state transition from ${this.getCurrentView()} to ${e}`}}async refreshState(){const e=await this.storageManager.getExtensionState();return e.success&&e.data&&(this.currentState=e.data,this.notifyStateChange(e.data)),e}notifyStateChange(e){this.stateChangeListeners.forEach(t=>{try{t(e)}catch(e){console.error("Error in state change listener:",e)}})}}new s;class n{constructor(e){this.currentStepIndex=0,this.steps=[{id:"welcome",title:"Welcome to FastGPT Extension",description:"This extension connects you to your FastGPT knowledge base directly from your browser. Let's get you set up in just a few steps!",completed:!1},{id:"visit-fastgpt",title:"Access FastGPT Platform",description:"Choose your preferred FastGPT platform to create an account or sign in. Both platforms offer the same powerful AI capabilities.",actionUrl:"https://fastgpt.io",actionText:"Choose Platform",completed:!1},{id:"create-knowledge-base",title:"Create Your Knowledge Base",description:"Upload your documents, PDFs, or text content to create a personalized knowledge base. This will be the source of information for your AI assistant.",completed:!1},{id:"create-simple-app",title:"Build Your AI App",description:"Create a simple app in FastGPT that connects to your knowledge base. This app will handle conversations and provide intelligent responses.",completed:!1},{id:"get-credentials",title:"Get Your API Credentials",description:"Copy your FastGPT Base URL, App ID, and API Key from your app settings. These credentials will connect the extension to your AI assistant.",completed:!1}],this.stateManager=e}async render(e){console.log("Onboarding render called, current step:",this.currentStepIndex),await this.loadProgress(),console.log("Progress loaded, current step:",this.currentStepIndex),e.innerHTML=this.getOnboardingHTML(),console.log("HTML updated"),this.attachEventListeners(e),console.log("Event listeners attached")}getOnboardingHTML(){const e=this.steps[this.currentStepIndex];return`\n      <div class="onboarding-container view-container">\n        <div class="navigation-header">\n          <h1 class="navigation-title">FastGPT Setup</h1>\n          <div class="navigation-controls">\n            <div class="view-state-indicator onboarding">Setup</div>\n          </div>\n        </div>\n        \n        <div class="onboarding-header">\n          <div class="progress-bar">\n            <div class="progress-fill" style="width: ${(this.currentStepIndex+1)/this.steps.length*100}%"></div>\n          </div>\n          <div class="step-counter">Step ${this.currentStepIndex+1} of ${this.steps.length}</div>\n        </div>\n\n        <div class="onboarding-content">\n          <div class="step-icon">\n            ${this.getStepIcon(e.id)}\n          </div>\n          \n          <h2 class="step-title">${e.title}</h2>\n          <p class="step-description">${e.description}</p>\n\n          ${e.actionUrl?`\n            <div class="step-action">\n              <button class="action-button" data-url="${e.actionUrl}">\n                ${e.actionText||"Open Link"}\n              </button>\n            </div>\n          `:""}\n\n          ${this.getStepSpecificContent(e.id)}\n        </div>\n\n        <div class="onboarding-navigation">\n          <button class="nav-button secondary" id="prev-button" ${0===this.currentStepIndex?"disabled":""}>\n            Previous\n          </button>\n          \n          <div class="nav-buttons-right">\n            ${this.currentStepIndex===this.steps.length-1?'\n              <button class="nav-button primary" id="complete-button">\n                Complete Setup\n              </button>\n            ':'\n              <button class="nav-button secondary" id="skip-button">\n                Skip to Configuration\n              </button>\n              <button class="nav-button primary" id="next-button">\n                Next\n              </button>\n            '}\n          </div>\n        </div>\n      </div>\n    `}getStepIcon(e){return`<span class="step-emoji">${{welcome:"👋","visit-fastgpt":"🌐","create-knowledge-base":"📚","create-simple-app":"⚡","get-credentials":"🔑"}[e]||"📋"}</span>`}getStepSpecificContent(e){switch(e){case"welcome":return'\n          <div class="step-details">\n            <div class="feature-list">\n              <ul>\n                <li>🤖 AI-powered responses from your knowledge base</li>\n                <li>🔒 Secure, private conversations</li>\n                <li>⚡ Quick access from any webpage</li>\n              </ul>\n            </div>\n          </div>\n        ';case"visit-fastgpt":return'\n          <div class="platform-options">\n            <div class="platform-buttons">\n              <button class="platform-button" data-url="https://fastgpt.io">\n                <div class="platform-info">\n                  <strong>FastGPT.io</strong>\n                  <span>Global platform</span>\n                </div>\n              </button>\n              <button class="platform-button" data-url="https://fastgpt.cn">\n                <div class="platform-info">\n                  <strong>FastGPT.cn</strong>\n                  <span>China platform</span>\n                </div>\n              </button>\n            </div>\n          </div>\n        ';case"create-knowledge-base":return'\n          <div class="step-instructions">\n            <ol>\n              <li>Navigate to "Dataset" in FastGPT</li>\n              <li>Click "Create New"</li>\n              <li>Upload your documents (PDF, TXT, DOCX, etc.)</li>\n              <li>Wait for processing to complete</li>\n            </ol>\n          </div>\n        ';case"create-simple-app":return'\n          <div class="step-instructions">\n            <ol>\n              <li>Go to "Studio" section in FastGPT</li>\n              <li>Click "Team" and choose "Simple App"</li>\n              <li>Connect it to your knowledge base</li>\n              <li>Configure and publish your app</li>\n            </ol>\n          </div>\n        ';case"get-credentials":return'\n          <div class="step-instructions">\n            <ol>\n              <li>Choose the app in Studio and Click</li>\n              <li>Go to "Publish"tab</li>\n              <li>Click "API Request"</li>\n              <li>Click "Create New"</li>\n              <li>Copy API Base URL, App ID, and API Key</li>\n            </ol>\n            <div class="warning-box">\n              <strong>⚠️</strong> Keep your API key secure!\n            </div>\n          </div>\n        ';default:return""}}attachEventListeners(e){console.log("Attaching event listeners...");const t=e.querySelector("#prev-button");console.log("Previous button found:",!!t),t&&t.addEventListener("click",async()=>{console.log("Previous button clicked"),await this.goToPreviousStep(e)});const s=e.querySelector("#next-button");console.log("Next button found:",!!s),s&&s.addEventListener("click",t=>{t.preventDefault(),t.stopPropagation(),console.log("Next button clicked"),this.goToNextStep(e).catch(e=>{console.error("Error in goToNextStep:",e)})});const n=e.querySelector("#skip-button");n&&n.addEventListener("click",async()=>{console.log("Skip button clicked"),await this.completeOnboarding()});const a=e.querySelector("#complete-button");a&&a.addEventListener("click",async()=>await this.completeOnboarding()),e.querySelectorAll(".action-button, .platform-button").forEach(e=>{e.addEventListener("click",e=>{const t=e.target.getAttribute("data-url");t&&(this.openExternalLink(t),this.markCurrentStepCompleted())})})}async goToPreviousStep(e){console.log("goToPreviousStep called, current step:",this.currentStepIndex),this.currentStepIndex>0?(this.currentStepIndex--,console.log("Moving to previous step:",this.currentStepIndex),this.saveProgress(),await this.render(e)):console.log("Already at first step")}async goToNextStep(e){console.log("goToNextStep called, current step:",this.currentStepIndex),this.markCurrentStepCompleted(),this.currentStepIndex<this.steps.length-1?(this.currentStepIndex++,console.log("Moving to step:",this.currentStepIndex),this.saveProgress(),await this.render(e)):console.log("Already at last step")}async goToStep(e,t){e>=0&&e<this.steps.length&&(this.currentStepIndex=e,await this.render(t))}markCurrentStepCompleted(){this.steps[this.currentStepIndex].completed=!0,this.saveProgress()}saveProgress(){const e={currentStep:this.currentStepIndex,completedSteps:this.steps.map(e=>e.completed)};chrome.storage.local.set({onboardingProgress:e})}async loadProgress(){try{const e=await chrome.storage.local.get(["onboardingProgress"]);if(e.onboardingProgress){const t=e.onboardingProgress;this.currentStepIndex=Math.min(t.currentStep||0,this.steps.length-1),t.completedSteps&&Array.isArray(t.completedSteps)&&t.completedSteps.forEach((e,t)=>{t<this.steps.length&&(this.steps[t].completed=e)})}}catch(e){console.error("Failed to load onboarding progress:",e)}}async completeOnboarding(){try{this.steps.forEach(e=>e.completed=!0),this.saveProgress();const e=await this.stateManager.completeOnboarding();e.success?window.dispatchEvent(new CustomEvent("onboardingComplete")):(console.error("Failed to complete onboarding:",e.error),alert("Failed to complete onboarding. Please try again."))}catch(e){console.error("Error completing onboarding:",e),alert("An error occurred while completing onboarding.")}}openExternalLink(e){chrome.tabs.create({url:e})}getProgress(){const e=this.steps.filter(e=>e.completed).length;return{current:e,total:this.steps.length,percentage:e/this.steps.length*100}}isComplete(){return this.steps.every(e=>e.completed)}isAllStepsCompleted(){return this.steps.every(e=>e.completed)}updateStepIndicators(e){e.querySelectorAll(".step-indicator").forEach((e,t)=>{const s=this.steps[t];e.className=`step-indicator ${t===this.currentStepIndex?"active":""} ${s.completed?"completed":""}`,e.textContent=s.completed?"✓":(t+1).toString()})}reset(){this.currentStepIndex=0,this.steps.forEach(e=>{e.completed=!1})}}class a{constructor(e){this.defaultRetryOptions={maxRetries:3,baseDelay:1e3,maxDelay:1e4,backoffMultiplier:2},this.config=e}async testConnection(){try{const e=this.validateConfig();if(e)return{success:!1,error:e.message,details:"Configuration validation failed"};const t=await this.makeTestRequest();return t.success?{success:!0,details:"Connection test successful"}:{success:!1,error:t.error?.message||"Connection test failed",details:t.error?.type||"Unknown error"}}catch(e){return{success:!1,error:"Unexpected error during connection test",details:e instanceof Error?e.message:"Unknown error"}}}validateConfig(){if(!this.config.baseUrl)return{message:"Base URL is required",type:"validation"};if(!this.config.appId)return{message:"App ID is required",type:"validation"};if(!this.config.apiKey)return{message:"API Key is required",type:"validation"};try{const e=new URL(this.config.baseUrl);if(!["http:","https:"].includes(e.protocol))return{message:"Base URL must use HTTP or HTTPS protocol",type:"validation"}}catch{return{message:"Invalid Base URL format",type:"validation"}}return null}async makeTestRequest(){try{return await this.executeWithRetry(async()=>{const e=this.buildApiUrl("/v1/chat/completions"),t={chatId:`test_${Date.now()}`,stream:!1,detail:!1,messages:[{role:"user",content:"test connection"}]},s=await fetch(e,{method:"POST",headers:{Authorization:`Bearer ${this.config.apiKey}`,"Content-Type":"application/json"},body:JSON.stringify(t)});if(s.ok)return{success:!0};{const e=await this.parseErrorResponse(s);if(e.retryable)throw new Error(e.message);return{success:!1,error:e}}})}catch(e){return e instanceof TypeError&&e.message.includes("fetch")?{success:!1,error:{message:"Network error: Unable to connect to FastGPT server",type:"network",retryable:!0}}:{success:!1,error:{message:e instanceof Error?e.message:"Unknown network error",type:"network",retryable:!0}}}}buildApiUrl(e){const t=this.config.baseUrl.replace(/\/$/,""),s=t.includes("/api")?"":"/api";return`${t}${s}${e}`}async parseErrorResponse(e){try{const t=await e.json(),s=e.headers.get("Retry-After");switch(e.status){case 401:return{code:401,message:"Authentication failed: Invalid API key",type:"authentication",retryable:!1};case 403:return{code:403,message:"Access forbidden: Check your API key permissions",type:"authentication",retryable:!1};case 404:return{code:404,message:"API endpoint not found: Check your Base URL",type:"validation",retryable:!1};case 400:return{code:400,message:t.message||"Bad request: Invalid configuration",type:"validation",retryable:!1};case 429:return{code:429,message:"Rate limit exceeded: Too many requests",type:"server",retryable:!0,retryAfter:s?parseInt(s,10):void 0};case 500:case 502:case 503:case 504:return{code:e.status,message:"Server error: FastGPT service is temporarily unavailable",type:"server",retryable:!0,retryAfter:s?parseInt(s,10):void 0};case 408:return{code:408,message:"Request timeout: The server took too long to respond",type:"server",retryable:!0};default:return{code:e.status,message:t.message||`HTTP ${e.status}: ${e.statusText}`,type:"unknown",retryable:e.status>=500}}}catch{return{code:e.status,message:`HTTP ${e.status}: ${e.statusText}`,type:"unknown",retryable:e.status>=500}}}async executeWithRetry(e,t={}){const s={...this.defaultRetryOptions,...t};let n;for(let t=0;t<=s.maxRetries;t++)try{return await e()}catch(e){if(n=e,t===s.maxRetries)break;if(!this.isRetryableError(e))throw e;const a=this.calculateRetryDelay(t,s,e);await this.sleep(a)}throw n}isRetryableError(e){return!!(e instanceof TypeError&&e.message.includes("fetch")||e instanceof Error&&e.message.includes("Rate limit exceeded")||e instanceof Error&&e.message.includes("Server error")||e instanceof Error&&e.message.includes("Request timeout")||e instanceof Error&&e.message.includes("Network error"))}calculateRetryDelay(e,t,s){if(s instanceof Error&&s.message.includes("Rate limit exceeded"))return Math.min(t.baseDelay*Math.pow(t.backoffMultiplier,e+1),t.maxDelay);const n=Math.min(t.baseDelay*Math.pow(t.backoffMultiplier,e),t.maxDelay);return n+.1*Math.random()*n}sleep(e){return new Promise(t=>setTimeout(t,e))}async*sendMessageStream(e,t,s){const n=this.validateConfig();if(n)throw new Error(n.message);const a=await this.executeWithRetry(async()=>this.createStreamGenerator(e,t,s));yield*a}async*sendMessageStreamWithEvents(e,t,s,n){const a=this.validateConfig();if(a)return void(yield{type:"error",error:{type:"connection",message:a.message,recoverable:!1}});const r=`msg_${Date.now()}_${Math.random().toString(36).substr(2,9)}`;let o=0;try{yield{type:"start",metadata:{messageId:r,totalChunks:0,currentChunk:0}};const a=await this.executeWithRetry(async()=>this.createEnhancedStreamGenerator(e,t,s,n));for await(const e of a)o++,yield{type:"chunk",data:e,metadata:{messageId:r,currentChunk:o}};yield{type:"complete",metadata:{messageId:r,totalChunks:o,currentChunk:o}}}catch(e){const t=this.classifyStreamingError(e);yield{type:"error",error:t,metadata:{messageId:r,currentChunk:o}}}}async createEnhancedStreamGenerator(e,t,s,n){const a=this.buildApiUrl("/v1/chat/completions"),r={chatId:t,stream:!0,detail:!1,messages:[{role:"user",content:e}],variables:s},o=new AbortController,i=n?.timeout?setTimeout(()=>{o.abort()},n.timeout):null;n?.abortSignal&&n.abortSignal.addEventListener("abort",()=>{o.abort()});try{const e=await fetch(a,{method:"POST",headers:{Authorization:`Bearer ${this.config.apiKey}`,"Content-Type":"application/json"},body:JSON.stringify(r),signal:o.signal});if(i&&clearTimeout(i),!e.ok){const t=await this.parseErrorResponse(e);if(t.retryable)throw new Error(t.message);throw new Error(t.message)}if(!e.body)throw new Error("No response body received");return this.processEnhancedStreamResponse(e.body,o.signal)}catch(e){if(i&&clearTimeout(i),e instanceof Error&&"AbortError"===e.name)throw new Error("Request was aborted");throw e}}async createStreamGenerator(e,t,s){const n=this.buildApiUrl("/v1/chat/completions"),a={chatId:t,stream:!0,detail:!1,messages:[{role:"user",content:e}],variables:s},r=await fetch(n,{method:"POST",headers:{Authorization:`Bearer ${this.config.apiKey}`,"Content-Type":"application/json"},body:JSON.stringify(a)});if(!r.ok){const e=await this.parseErrorResponse(r);if(e.retryable)throw new Error(e.message);throw new Error(e.message)}if(!r.body)throw new Error("No response body received");return this.processStreamResponse(r.body)}async*processEnhancedStreamResponse(e,t){const s=e.getReader(),n=new TextDecoder;let a="";try{for(;;){if(t?.aborted)throw new Error("Stream was aborted");const{done:e,value:r}=await s.read();if(e)break;a+=n.decode(r,{stream:!0});const o=a.split("\n");a=o.pop()||"";for(const e of o){const t=e.trim();if(""!==t&&"data: [DONE]"!==t&&t.startsWith("data: "))try{const e=t.slice(6),s=JSON.parse(e);s.choices&&s.choices[0]&&s.choices[0].delta.content&&(yield s.choices[0].delta.content)}catch(e){console.warn("Failed to parse streaming chunk:",e);continue}}}if(a.trim()){const e=a.trim();if(e.startsWith("data: ")&&"data: [DONE]"!==e)try{const t=e.slice(6),s=JSON.parse(t);s.choices&&s.choices[0]&&s.choices[0].delta.content&&(yield s.choices[0].delta.content)}catch(e){console.warn("Failed to parse final streaming chunk:",e)}}}catch(e){if(e instanceof Error&&"AbortError"===e.name)throw new Error("Stream was aborted");if(e instanceof Error&&e.message.includes("network"))throw new Error("Network connection lost during streaming");throw e}finally{s.releaseLock()}}async*processStreamResponse(e){const t=e.getReader(),s=new TextDecoder;try{for(console.log("Starting to process stream response");;){const{done:e,value:n}=await t.read();if(e){console.log("Stream reading completed");break}const a=s.decode(n,{stream:!0});console.log("Received chunk:",a);const r=a.split("\n");for(const e of r){const t=e.trim();if(console.log("Processing line:",t),""!==t&&"data: [DONE]"!==t&&t.startsWith("data: "))try{const e=t.slice(6);console.log("Parsing JSON:",e);const s=JSON.parse(e);if(console.log("Parsed data:",s),s.code&&s.statusText&&s.message){let e="❌ FastGPT API 错误\n\n";throw e+=`• 错误代码: ${s.code}\n`,e+=`• 状态: ${s.statusText}\n`,e+=`• 消息: ${s.message}`,s.data&&(e+=`\n• 详细信息: ${JSON.stringify(s.data)}`),"aiPointsNotEnough"===s.statusText?e+="\n\n💡 这通常表示您的 FastGPT 账户余额不足，请前往 FastGPT 平台充值。":"authenticationFailed"===s.statusText?e+="\n\n💡 请检查您的 API 密钥是否正确配置。":"rateLimitExceeded"===s.statusText&&(e+="\n\n💡 请求过于频繁，请稍后再试。"),new Error(e)}s.choices&&s.choices[0]&&s.choices[0].delta&&s.choices[0].delta.content&&(console.log("Yielding content:",s.choices[0].delta.content),yield s.choices[0].delta.content)}catch(e){if(console.error("JSON parse error:",e,"for line:",t),e instanceof Error&&e.message.startsWith("❌"))throw e;continue}}}}finally{t.releaseLock()}}async sendMessage(e,t,s){const n=this.validateConfig();if(n)throw new Error(n.message);return await this.executeWithRetry(async()=>{const n=this.buildApiUrl("/v1/chat/completions"),a={chatId:t,stream:!1,detail:!1,messages:[{role:"user",content:e}],variables:s},r=await fetch(n,{method:"POST",headers:{Authorization:`Bearer ${this.config.apiKey}`,"Content-Type":"application/json"},body:JSON.stringify(a)});if(!r.ok){const e=await this.parseErrorResponse(r);if(e.retryable)throw new Error(e.message);throw new Error(e.message)}const o=await r.json();if(o.choices&&o.choices[0]&&o.choices[0].message)return o.choices[0].message.content;throw new Error("Invalid response format from FastGPT API")})}async sendMessageWithHistory(e,t,s){const n=this.validateConfig();if(n)throw new Error(n.message);return await this.executeWithRetry(async()=>{const n=this.buildApiUrl("/v1/chat/completions"),a=e.map(e=>({role:e.role,content:e.content})),r={chatId:t,stream:!1,detail:!1,messages:a,variables:s},o=await fetch(n,{method:"POST",headers:{Authorization:`Bearer ${this.config.apiKey}`,"Content-Type":"application/json"},body:JSON.stringify(r)});if(!o.ok){const e=await this.parseErrorResponse(o);if(e.retryable)throw new Error(e.message);throw new Error(e.message)}const i=await o.json();if(i.choices&&i.choices[0]&&i.choices[0].message)return i.choices[0].message.content;throw new Error("Invalid response format from FastGPT API")})}async*sendMessageWithHistoryStream(e,t,s){const n=this.validateConfig();if(n)throw new Error(n.message);const a=await this.executeWithRetry(async()=>this.createStreamGeneratorWithHistory(e,t,s));yield*a}async createStreamGeneratorWithHistory(e,t,s){const n=this.buildApiUrl("/v1/chat/completions"),a={chatId:t,stream:!0,detail:!1,messages:e.map(e=>({role:e.role,content:e.content})),variables:s},r=await fetch(n,{method:"POST",headers:{Authorization:`Bearer ${this.config.apiKey}`,"Content-Type":"application/json"},body:JSON.stringify(a)});if(!r.ok){const e=await this.parseErrorResponse(r);if(e.retryable)throw new Error(e.message);throw new Error(e.message)}if(!r.body)throw new Error("No response body received");return this.processStreamResponse(r.body)}classifyStreamingError(e){return e instanceof Error?"AbortError"===e.name||e.message.includes("aborted")?{type:"abort",message:"Request was cancelled or timed out",recoverable:!0}:e.message.includes("timeout")?{type:"timeout",message:"Request timed out while streaming",recoverable:!0}:e.message.includes("network")||e.message.includes("fetch")||e.message.includes("connection lost")?{type:"connection",message:"Network connection lost during streaming",recoverable:!0}:e.message.includes("parse")||e.message.includes("JSON")?{type:"parsing",message:"Failed to parse streaming response",recoverable:!1}:e.message.includes("Authentication failed")||e.message.includes("Invalid API key")||e.message.includes("Access forbidden")?{type:"connection",message:e.message,recoverable:!1}:(e.message.includes("Server error")||e.message.includes("service unavailable"),{type:"connection",message:e.message,recoverable:!0}):{type:"connection",message:"An unknown error occurred during streaming",recoverable:!1}}async*sendMessageWithHistoryStreamWithEvents(e,t,s,n){const a=this.validateConfig();if(a)return void(yield{type:"error",error:{type:"connection",message:a.message,recoverable:!1}});const r=`msg_${Date.now()}_${Math.random().toString(36).substr(2,9)}`;let o=0;try{yield{type:"start",metadata:{messageId:r,totalChunks:0,currentChunk:0}};const a=await this.executeWithRetry(async()=>this.createEnhancedStreamGeneratorWithHistory(e,t,s,n));for await(const e of a)o++,yield{type:"chunk",data:e,metadata:{messageId:r,currentChunk:o}};yield{type:"complete",metadata:{messageId:r,totalChunks:o,currentChunk:o}}}catch(e){const t=this.classifyStreamingError(e);yield{type:"error",error:t,metadata:{messageId:r,currentChunk:o}}}}async createEnhancedStreamGeneratorWithHistory(e,t,s,n){const a=this.buildApiUrl("/v1/chat/completions"),r={chatId:t,stream:!0,detail:!1,messages:e.map(e=>({role:e.role,content:e.content})),variables:s},o=new AbortController,i=n?.timeout?setTimeout(()=>{o.abort()},n.timeout):null;n?.abortSignal&&n.abortSignal.addEventListener("abort",()=>{o.abort()});try{const e=await fetch(a,{method:"POST",headers:{Authorization:`Bearer ${this.config.apiKey}`,"Content-Type":"application/json"},body:JSON.stringify(r),signal:o.signal});if(i&&clearTimeout(i),!e.ok){const t=await this.parseErrorResponse(e);if(t.retryable)throw new Error(t.message);throw new Error(t.message)}if(!e.body)throw new Error("No response body received");return this.processEnhancedStreamResponse(e.body,o.signal)}catch(e){if(i&&clearTimeout(i),e instanceof Error&&"AbortError"===e.name)throw new Error("Request was aborted");throw e}}static getErrorMessage(e){switch(e.type){case"network":return"Unable to connect to FastGPT server. Please check your internet connection and Base URL.";case"authentication":return"Authentication failed. Please check your API key and ensure it has the correct permissions.";case"validation":return"Configuration error. Please verify your Base URL, App ID, and API key are correct.";case"server":return"FastGPT server is temporarily unavailable. Please try again later.";default:return e.message||"An unexpected error occurred during connection test."}}}class r{constructor(e){this.container=null,this.formData={},this.stateManager=e}async render(e){this.container=e,await this.loadExistingConfiguration(),this.container.innerHTML=this.getConfigurationHTML(),this.setupEventListeners()}async loadExistingConfiguration(){await this.stateManager.loadState();const e=this.stateManager.getCurrentState();e?.fastgptConfig&&(this.formData={...e.fastgptConfig})}getConfigurationHTML(){return`\n      <div class="configuration-container view-container">\n        <div class="navigation-header">\n          <h1 class="navigation-title">Configure FastGPT Connection</h1>\n          <div class="navigation-controls">\n            <button class="nav-control-button" id="back-to-onboarding-nav">\n              ← Setup\n            </button>\n            <div class="view-state-indicator configuration">Config</div>\n          </div>\n        </div>\n        \n        <div class="breadcrumb-nav">\n          <div class="breadcrumb-item">\n            <span class="breadcrumb-link" id="breadcrumb-onboarding">Setup</span>\n            <span class="breadcrumb-separator">›</span>\n          </div>\n          <div class="breadcrumb-item">\n            <span class="breadcrumb-current">Configuration</span>\n          </div>\n        </div>\n        \n        <div class="configuration-header">\n          <p class="configuration-subtitle">\n            Enter your FastGPT connection details to start chatting with your knowledge base.\n          </p>\n        </div>\n\n        <form id="configuration-form" class="configuration-form" novalidate>\n          <div class="form-group">\n            <label for="baseUrl" class="form-label">\n              FastGPT Base URL <span class="required">*</span>\n            </label>\n            <input\n              type="url"\n              id="baseUrl"\n              name="baseUrl"\n              class="form-input"\n              placeholder="https://your-fastgpt-instance.com"\n              value="${this.formData.baseUrl||""}"\n            />\n            <div class="field-help">\n              The base URL of your FastGPT instance (e.g., https://fastgpt.io or your self-hosted URL)\n            </div>\n          </div>\n\n          <div class="form-group">\n            <label for="appId" class="form-label">\n              App ID <span class="required">*</span>\n            </label>\n            <input\n              type="text"\n              id="appId"\n              name="appId"\n              class="form-input"\n              placeholder="Enter your FastGPT App ID"\n              value="${this.formData.appId||""}"\n            />\n            <div class="field-help">\n              The unique identifier for your FastGPT application\n            </div>\n          </div>\n\n          <div class="form-group">\n            <label for="apiKey" class="form-label">\n              API Key <span class="required">*</span>\n            </label>\n            <input\n              type="password"\n              id="apiKey"\n              name="apiKey"\n              class="form-input"\n              placeholder="Enter your FastGPT API Key"\n              value="${this.formData.apiKey||""}"\n            />\n            <div class="field-help">\n              Your FastGPT API key for authentication (will be stored securely)\n            </div>\n          </div>\n\n          <div class="form-actions">\n            <button type="button" id="test-connection" class="nav-button secondary">\n              Test Connection\n            </button>\n            <button type="submit" id="save-configuration" class="nav-button primary">\n              Save Configuration\n            </button>\n          </div>\n        </form>\n\n        <div class="configuration-footer">\n          <button id="back-to-onboarding" class="nav-button secondary">\n            ← Back to Setup\n          </button>\n        </div>\n      </div>\n    `}setupEventListeners(){if(!this.container)return;const e=this.container.querySelector("#configuration-form"),t=this.container.querySelector("#baseUrl"),s=this.container.querySelector("#appId"),n=this.container.querySelector("#apiKey"),a=this.container.querySelector("#test-connection"),r=(this.container.querySelector("#save-configuration"),this.container.querySelector("#back-to-onboarding"));[t,s,n].forEach(e=>{e&&e.addEventListener("input",()=>{this.handleInputChange(e)})}),e&&e.addEventListener("submit",e=>{e.preventDefault(),this.handleFormSubmit()}),a&&a.addEventListener("click",()=>{this.handleTestConnection()}),r&&r.addEventListener("click",async()=>{await this.stateManager.resetOnboarding()});const o=this.container.querySelector("#back-to-onboarding-nav"),i=this.container.querySelector("#breadcrumb-onboarding");o&&o.addEventListener("click",async()=>{await this.stateManager.setCurrentView("onboarding"),window.dispatchEvent(new CustomEvent("viewChange"))}),i&&i.addEventListener("click",async()=>{await this.stateManager.setCurrentView("onboarding"),window.dispatchEvent(new CustomEvent("viewChange"))})}handleInputChange(e){const t=e.name;this.formData[t]=e.value}async handleFormSubmit(){this.setLoadingState(!0);try{const e=await this.stateManager.completeConfiguration(this.formData);e.success?this.showSuccessMessage("Configuration saved successfully!"):this.showErrorMessage(e.error||"Failed to save configuration")}catch(e){this.showErrorMessage("An unexpected error occurred while saving configuration"),console.error("Configuration save error:",e)}finally{this.setLoadingState(!1)}}async handleTestConnection(){this.setTestingState(!0);try{const e=this.formData,t=new a(e),s=await t.testConnection();if(s.success)this.showSuccessMessage("Connection test successful! Your FastGPT configuration is working correctly.");else{const t=this.getUserFriendlyErrorMessage(s.error||"Connection test failed");this.showErrorMessage(t),console.error("Connection test failed:",{error:s.error,details:s.details,config:{baseUrl:e.baseUrl,appId:e.appId,hasApiKey:!!e.apiKey}})}}catch(e){this.showErrorMessage("An unexpected error occurred during connection test. Please try again."),console.error("Connection test error:",e)}finally{this.setTestingState(!1)}}setLoadingState(e){if(!this.container)return;const t=this.container.querySelector("#save-configuration"),s=this.container.querySelector("#test-connection");t&&(t.disabled=e,t.textContent=e?"Saving...":"Save Configuration"),s&&(s.disabled=e)}setTestingState(e){if(!this.container)return;const t=this.container.querySelector("#test-connection"),s=this.container.querySelector("#save-configuration");t&&(t.disabled=e,t.textContent=e?"Testing...":"Test Connection"),s&&(s.disabled=e)}getUserFriendlyErrorMessage(e){return e.includes("Network error")||e.includes("fetch")?"Unable to connect to FastGPT server. Please check your internet connection and Base URL.":e.includes("Authentication failed")||e.includes("401")?"Authentication failed. Please check your API key and ensure it has the correct permissions.":e.includes("Access forbidden")||e.includes("403")?"Access forbidden. Please verify your API key has the necessary permissions for this app.":e.includes("API endpoint not found")||e.includes("404")?"API endpoint not found. Please verify your Base URL is correct and includes the full path to your FastGPT instance.":e.includes("Bad request")||e.includes("400")?"Invalid configuration. Please check that your App ID and API key are correct.":e.includes("Rate limit")||e.includes("429")?"Too many requests. Please wait a moment before testing the connection again.":e.includes("Server error")||e.includes("500")||e.includes("502")||e.includes("503")||e.includes("504")?"FastGPT server is temporarily unavailable. Please try again in a few minutes.":e.includes("Base URL")||e.includes("URL")?"Invalid Base URL. Please ensure it starts with https:// and points to your FastGPT instance.":e.includes("App ID")?"Invalid App ID. Please check that you've entered the correct App ID from your FastGPT application.":e.includes("API Key")?"Invalid API Key. Please ensure you're using an application-specific API key, not a general key.":e||"Connection test failed. Please check your configuration and try again."}showSuccessMessage(e){this.showMessage(e,"success")}showErrorMessage(e){this.showMessage(e,"error")}showMessage(e,t){if(!this.container)return;const s=this.container.querySelector(".message");s&&s.remove();const n=document.createElement("div");n.className=`message message-${t}`,n.textContent=e;const a=this.container.querySelector(".configuration-form");a&&a.insertBefore(n,a.firstChild),"success"===t&&setTimeout(()=>{n.parentNode&&n.remove()},3e3)}async updateConfiguration(e){await this.loadExistingConfiguration(),this.formData={...this.formData,...e},this.container&&(this.container.innerHTML=this.getConfigurationHTML(),this.setupEventListeners())}getCurrentConfiguration(){return{...this.formData}}async isConfigurationModified(){const e=this.stateManager.getCurrentState(),t=e?.fastgptConfig;return!(!t&&0===Object.keys(this.formData).length||t&&0!==Object.keys(this.formData).length&&this.formData.baseUrl===t.baseUrl&&this.formData.appId===t.appId&&this.formData.apiKey===t.apiKey)}}class o{constructor(e){this.fastgptClient=null,this.currentSession=null,this.isLoading=!1,this.isStreaming=!1,this.stateManager=e,this.storageManager=new t}async render(e){await this.initializeFastGPTClient(),e.innerHTML=this.createChatHTML(),this.setupEventListeners(e),await this.loadOrCreateChatSession(),this.renderMessages()}async initializeFastGPTClient(){const e=this.stateManager.getFastGPTConfig();e&&(this.fastgptClient=new a(e))}createChatHTML(){return'\n      <div class="chat-container view-container">\n        <div class="navigation-header">\n          <h1 class="navigation-title">FastGPT Chat</h1>\n          <div class="navigation-controls">\n            <button class="nav-control-button" id="go-to-config-nav" title="Configuration">\n              ⚙️ Config\n            </button>\n            <button class="nav-control-button" id="settings-button" title="Settings">\n              ⋯\n            </button>\n            <div class="view-state-indicator chat">Chat</div>\n          </div>\n        </div>\n        \n        <div class="breadcrumb-nav">\n          <div class="breadcrumb-item">\n            <span class="breadcrumb-link" id="breadcrumb-onboarding">Setup</span>\n            <span class="breadcrumb-separator">›</span>\n          </div>\n          <div class="breadcrumb-item">\n            <span class="breadcrumb-link" id="breadcrumb-configuration">Configuration</span>\n            <span class="breadcrumb-separator">›</span>\n          </div>\n          <div class="breadcrumb-item">\n            <span class="breadcrumb-current">Chat</span>\n          </div>\n        </div>\n        \n        <div class="chat-header">\n          <div class="status-bar">\n            <div class="status-item">\n              <div class="status-indicator"></div>\n              <span>Connected</span>\n            </div>\n            <div class="status-item">\n              <span id="message-count">0 messages</span>\n            </div>\n          </div>\n        </div>\n        \n        <div class="chat-messages" id="chat-messages">\n          \x3c!-- Messages will be rendered here --\x3e\n        </div>\n        \n        <div class="chat-input-container">\n          <div class="typing-indicator" id="typing-indicator" style="display: none;">\n            <span class="typing-dots">\n              <span></span>\n              <span></span>\n              <span></span>\n            </span>\n            <span class="typing-text">FastGPT is typing...</span>\n          </div>\n          \n          <div class="chat-input-wrapper">\n            <textarea \n              id="message-input" \n              class="message-input" \n              placeholder="Type your message here..."\n              rows="1"\n            ></textarea>\n            <button id="send-button" class="send-button" disabled>\n              <span class="send-icon">➤</span>\n            </button>\n          </div>\n        </div>\n        \n\n      </div>\n    '}setupEventListeners(e){const t=e.querySelector("#message-input"),s=e.querySelector("#send-button"),n=e.querySelector("#settings-button"),a=e.querySelector("#go-to-config-nav"),r=e.querySelector("#breadcrumb-onboarding"),o=e.querySelector("#breadcrumb-configuration");t&&(t.addEventListener("input",()=>{this.autoResizeTextarea(t),this.updateSendButtonState(t,s)}),t.addEventListener("keydown",e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),this.handleSendMessage(t))}),this.updateSendButtonState(t,s)),s&&s.addEventListener("click",()=>{this.handleSendMessage(t)}),n&&n.addEventListener("click",()=>{this.handleSettingsClick()}),a&&a.addEventListener("click",async()=>{await this.stateManager.setCurrentView("configuration"),window.dispatchEvent(new CustomEvent("viewChange"))}),r&&r.addEventListener("click",async()=>{await this.stateManager.setCurrentView("onboarding"),window.dispatchEvent(new CustomEvent("viewChange"))}),o&&o.addEventListener("click",async()=>{await this.stateManager.setCurrentView("configuration"),window.dispatchEvent(new CustomEvent("viewChange"))}),this.updateMessageCount()}autoResizeTextarea(e){e.style.height="auto";const t=Math.min(e.scrollHeight,120);e.style.height=t+"px"}updateSendButtonState(e,t){const s=e.value.trim().length>0&&!this.isLoading&&!this.isStreaming;t.disabled=!s,t.classList.toggle("active",s)}async handleSendMessage(e){const t=e.value.trim();if(t&&!this.isLoading&&!this.isStreaming&&this.fastgptClient){e.value="",e.style.height="auto";try{const e=this.createMessage("user",t);await this.addMessageToSession(e),this.renderMessages();const s=this.createMessage("assistant","");await this.addMessageToSession(s),this.renderMessages(),this.setStreamingState(!0),console.log("Starting stream for message:",t),console.log("Assistant message ID:",s.id),await this.streamMessageResponse(s,t)}catch(e){console.error("Error sending message:",e),await this.showErrorMessage("Failed to send message. Please try again.")}finally{this.updateSendButtonState(e,document.querySelector("#send-button"))}}}handleSettingsClick(){this.showSettingsMenu()}showSettingsMenu(){const e=document.createElement("div");e.className="settings-menu",e.innerHTML='\n      <div class="settings-menu-overlay" id="settings-overlay"></div>\n      <div class="settings-menu-content">\n        <div class="settings-menu-header">\n          <h3>Settings & Data Management</h3>\n          <button class="close-button" id="close-settings">✕</button>\n        </div>\n        <div class="settings-menu-body">\n          <div class="settings-section">\n            <div class="settings-section-title">Chat Management</div>\n            <button class="settings-option" id="new-chat">\n              <span class="option-icon">💬</span>\n              <span class="option-text">New Chat</span>\n            </button>\n            <button class="settings-option" id="clear-history">\n              <span class="option-icon">🗑️</span>\n              <span class="option-text">Clear Chat History</span>\n            </button>\n          </div>\n          \n          <div class="settings-section">\n            <div class="settings-section-title">Configuration</div>\n            <button class="settings-option" id="go-to-config">\n              <span class="option-icon">⚙️</span>\n              <span class="option-text">Edit Configuration</span>\n            </button>\n            <button class="settings-option" id="reset-config">\n              <span class="option-icon">🔄</span>\n              <span class="option-text">Reset Configuration</span>\n            </button>\n          </div>\n          \n          <div class="settings-section">\n            <div class="settings-section-title">Data Management</div>\n            <button class="settings-option" id="export-data">\n              <span class="option-icon">📤</span>\n              <span class="option-text">Export Data</span>\n            </button>\n            <button class="settings-option" id="import-data">\n              <span class="option-icon">📥</span>\n              <span class="option-text">Import Data</span>\n            </button>\n            <button class="settings-option danger" id="reset-all">\n              <span class="option-icon">⚠️</span>\n              <span class="option-text">Reset All Data</span>\n            </button>\n          </div>\n        </div>\n      </div>\n    ',document.body.appendChild(e),this.setupSettingsMenuListeners(e)}setupSettingsMenuListeners(e){const t=e.querySelector("#settings-overlay"),s=e.querySelector("#close-settings"),n=e.querySelector("#new-chat"),a=e.querySelector("#clear-history"),r=e.querySelector("#go-to-config"),o=e.querySelector("#reset-config"),i=e.querySelector("#export-data"),c=e.querySelector("#import-data"),l=e.querySelector("#reset-all"),d=()=>{document.body.removeChild(e)};t?.addEventListener("click",d),s?.addEventListener("click",d),n?.addEventListener("click",async()=>{await this.startNewChat(),d()}),a?.addEventListener("click",async()=>{await this.confirmAction("Clear Chat History","Are you sure you want to clear all chat history? This action cannot be undone.")&&await this.clearChatHistory(),d()}),r?.addEventListener("click",async()=>{await this.stateManager.setCurrentView("configuration"),window.dispatchEvent(new CustomEvent("viewChange",{detail:{view:"configuration"}})),d()}),o?.addEventListener("click",async()=>{await this.confirmAction("Reset Configuration","Are you sure you want to reset your FastGPT configuration? You will need to reconfigure your connection settings.")&&await this.resetConfiguration(),d()}),i?.addEventListener("click",async()=>{await this.exportData(),d()}),c?.addEventListener("click",async()=>{await this.importData(),d()}),l?.addEventListener("click",async()=>{await this.confirmAction("Reset All Data","Are you sure you want to reset ALL extension data? This will clear your configuration, chat history, and all settings. This action cannot be undone.",!0)&&await this.resetAllData(),d()})}setStreamingState(e){this.isStreaming=e;const t=document.querySelector("#message-input"),s=document.querySelector("#send-button");t&&(t.disabled=e),s&&this.updateSendButtonState(t,s)}showTypingIndicator(e){const t=document.querySelector("#typing-indicator");t&&(t.style.display=e?"flex":"none")}async streamMessageResponse(e,t){if(console.log("streamMessageResponse called with:",{assistantMessage:e,userMessage:t}),!this.fastgptClient||!this.currentSession)throw console.error("Missing dependencies:",{fastgptClient:!!this.fastgptClient,currentSession:!!this.currentSession}),new Error("FastGPT client or current session not available");let s="";try{const n=document.querySelector(`[data-message-id="${e.id}"]`);console.log("Found message element:",!!n);const a=n?.querySelector(".message-content"),r=n?.querySelector(".message-text");if(console.log("Found sub-elements:",{messageContentElement:!!a,messageTextElement:!!r}),!r||!a)throw console.error("Message elements not found for ID:",e.id),new Error("Message element not found for streaming updates");n?.classList.add("streaming"),a.classList.add("streaming");const o=this.fastgptClient.sendMessageStream(t,this.currentSession.id);let i=0;for await(const t of o){if(!this.isStreaming){console.log("Streaming was interrupted by user");break}s+=t,i++,e.content=s,r.innerHTML=this.formatMessageContent(s),this.scrollToBottom(),i%5==0&&await this.sleep(20)}n?.classList.remove("streaming"),a.classList.remove("streaming"),e.content=s,e.timestamp=new Date,r.innerHTML=this.formatMessageContent(s),await this.saveChatSession(),console.log(`Streaming completed successfully with ${i} chunks`),n?.classList.remove("streaming"),a.classList.remove("streaming"),e.content=s,e.timestamp=new Date,r.innerHTML=this.formatMessageContent(s),await this.saveChatSession(),console.log(`Streaming completed successfully with ${i} chunks`)}catch(t){console.error("Error during streaming:",t);const n=document.querySelector(`[data-message-id="${e.id}"]`),a=n?.querySelector(".message-content");n?.classList.remove("streaming"),a?.classList.remove("streaming"),t instanceof Error?t.message.includes("aborted")||t.message.includes("cancelled")?e.content=s+"\n\n_[Response was interrupted]_":t.message.includes("network")||t.message.includes("connection")?e.content=s+"\n\n❌ _Connection lost during response. Please try again._":t.message.includes("timeout")?e.content=s+"\n\n❌ _Request timed out. Please try again._":e.content=s+"\n\n❌ _An error occurred while receiving the response._":e.content=s+"\n\n❌ _An unexpected error occurred._";const r=n?.querySelector(".message-text");throw r&&(r.innerHTML=this.formatMessageContent(e.content)),await this.saveChatSession(),t}finally{this.setStreamingState(!1)}}scrollToBottom(){const e=document.querySelector("#chat-messages");e&&(e.scrollTop=e.scrollHeight)}sleep(e){return new Promise(t=>setTimeout(t,e))}async showErrorMessage(e){const t=this.createMessage("assistant",`❌ ${e}`);await this.addMessageToSession(t),this.renderMessages()}createMessage(e,t){return{id:this.generateMessageId(),role:e,content:t,timestamp:new Date}}generateMessageId(){return`msg_${Date.now()}_${Math.random().toString(36).substring(2,11)}`}async loadOrCreateChatSession(){try{const e=await this.storageManager.getChatSessions();if(e.success&&e.data){const t=e.data,s=Object.keys(t);if(s.length>0){const e=s.reduce((e,s)=>{const n=new Date(t[e].updatedAt);return new Date(t[s].updatedAt)>n?s:e}),n=t[e];return this.currentSession={id:e,messages:n.messages.map(e=>({...e,timestamp:new Date(e.timestamp)})),createdAt:new Date(n.createdAt),updatedAt:new Date(n.updatedAt)},void console.log(`Loaded existing chat session: ${e} with ${this.currentSession.messages.length} messages`)}}await this.createNewChatSession()}catch(e){console.error("Error loading chat session:",e),await this.createNewChatSession()}}async createNewChatSession(){this.currentSession={id:this.generateSessionId(),messages:[],createdAt:new Date,updatedAt:new Date},await this.saveChatSession(),console.log(`Created new chat session: ${this.currentSession.id}`)}generateSessionId(){return`session_${Date.now()}_${Math.random().toString(36).substring(2,11)}`}async addMessageToSession(e){this.currentSession&&(this.currentSession.messages.push(e),this.currentSession.updatedAt=new Date,await this.saveChatSession())}async saveChatSession(){if(this.currentSession)try{const e=await this.storageManager.setChatSession(this.currentSession.id,this.currentSession);e.success||console.error("Failed to save chat session:",e.error)}catch(e){console.error("Error saving chat session:",e)}}renderMessages(){const e=document.querySelector("#chat-messages");e&&this.currentSession&&(e.innerHTML="",0!==this.currentSession.messages.length?(this.currentSession.messages.forEach(t=>{const s=this.createMessageElement(t);e.appendChild(s)}),e.scrollTop=e.scrollHeight,this.updateMessageCount()):e.innerHTML='\n        <div class="welcome-message">\n          <div class="welcome-icon">🤖</div>\n          <h3>Welcome to FastGPT!</h3>\n          <p>Start a conversation by typing a message below.</p>\n        </div>\n      ')}createMessageElement(e){const t=document.createElement("div");t.className=`message message-${e.role}`,t.setAttribute("data-message-id",e.id);const s=this.formatTimestamp(e.timestamp);return t.innerHTML=`\n      <div class="message-content">\n        <div class="message-text">${this.formatMessageContent(e.content)}</div>\n        <div class="message-timestamp">${s}</div>\n      </div>\n    `,t}formatMessageContent(e){return e?e.replace(/\n/g,"<br>"):""}formatTimestamp(e){const t=(new Date).getTime()-e.getTime();return t<6e4?"Just now":t<36e5?`${Math.floor(t/6e4)}m ago`:t<864e5?`${Math.floor(t/36e5)}h ago`:e.toLocaleDateString()}async startNewChat(){try{await this.createNewChatSession(),this.renderMessages(),console.log("Started new chat session")}catch(e){console.error("Error starting new chat:",e),await this.showErrorMessage("Failed to start new chat. Please try again.")}}async clearChatHistory(){try{const e=await this.storageManager.getChatSessions();if(e.success&&e.data&&Object.keys(e.data).length>0){const e=await this.storageManager.removeData(["chatSessions"]);if(!e.success)throw new Error(e.error||"Failed to clear chat history")}await this.createNewChatSession(),this.renderMessages(),console.log("Chat history cleared successfully")}catch(e){console.error("Error clearing chat history:",e),await this.showErrorMessage("Failed to clear chat history. Please try again.")}}async getAllChatSessions(){try{const e=await this.storageManager.getChatSessions();if(e.success&&e.data){const t={};return Object.entries(e.data).forEach(([e,s])=>{t[e]={id:e,messages:s.messages.map(e=>({...e,timestamp:new Date(e.timestamp)})),createdAt:new Date(s.createdAt),updatedAt:new Date(s.updatedAt)}}),t}return null}catch(e){return console.error("Error getting chat sessions:",e),null}}async loadChatSession(e){try{const t=await this.storageManager.getChatSessions();if(t.success&&t.data&&t.data[e]){const s=t.data[e];return this.currentSession={id:e,messages:s.messages.map(e=>({...e,timestamp:new Date(e.timestamp)})),createdAt:new Date(s.createdAt),updatedAt:new Date(s.updatedAt)},this.renderMessages(),console.log(`Loaded chat session: ${e} with ${this.currentSession.messages.length} messages`),!0}return!1}catch(e){return console.error("Error loading chat session:",e),!1}}updateMessageCount(){const e=document.querySelector("#message-count");if(e&&this.currentSession){const t=this.currentSession.messages.length;e.textContent=`${t} message${1!==t?"s":""}`}}async confirmAction(e,t,s=!1){return new Promise(n=>{const a=document.createElement("div");a.className="confirm-dialog",a.innerHTML=`\n        <div class="confirm-dialog-overlay"></div>\n        <div class="confirm-dialog-content">\n          <div class="confirm-dialog-header ${s?"danger":""}">\n            <h3>${e}</h3>\n          </div>\n          <div class="confirm-dialog-body">\n            <p>${t}</p>\n          </div>\n          <div class="confirm-dialog-actions">\n            <button class="nav-button secondary" id="confirm-cancel">Cancel</button>\n            <button class="nav-button ${s?"danger":"primary"}" id="confirm-ok">\n              ${s?"Delete":"Confirm"}\n            </button>\n          </div>\n        </div>\n      `,document.body.appendChild(a);const r=a.querySelector("#confirm-cancel"),o=a.querySelector("#confirm-ok"),i=a.querySelector(".confirm-dialog-overlay"),c=()=>{document.body.removeChild(a)};r.addEventListener("click",()=>{c(),n(!1)}),o.addEventListener("click",()=>{c(),n(!0)}),i.addEventListener("click",()=>{c(),n(!1)})})}async resetConfiguration(){try{(await this.stateManager.resetConfiguration()).success?(await this.stateManager.setCurrentView("configuration"),window.dispatchEvent(new CustomEvent("viewChange"))):await this.showErrorMessage("Failed to reset configuration. Please try again.")}catch(e){console.error("Error resetting configuration:",e),await this.showErrorMessage("An error occurred while resetting configuration.")}}async exportData(){try{const[e,t]=await Promise.all([this.storageManager.getChatSessions(),this.stateManager.getCurrentState()]),s={version:"1.0.0",exportDate:(new Date).toISOString(),chatSessions:e.success?e.data:{},extensionState:t,metadata:{totalSessions:e.success&&e.data?Object.keys(e.data).length:0,totalMessages:this.getTotalMessageCount(e.success?e.data:{})}},n=new Blob([JSON.stringify(s,null,2)],{type:"application/json"}),a=URL.createObjectURL(n),r=document.createElement("a");r.href=a,r.download=`fastgpt-extension-data-${(new Date).toISOString().split("T")[0]}.json`,document.body.appendChild(r),r.click(),document.body.removeChild(r),URL.revokeObjectURL(a),console.log("Data exported successfully")}catch(e){console.error("Error exporting data:",e),await this.showErrorMessage("Failed to export data. Please try again.")}}async importData(){try{const e=document.createElement("input");e.type="file",e.accept=".json",e.onchange=async e=>{const t=e.target.files?.[0];if(t)try{const e=await t.text(),s=JSON.parse(e);if(!this.validateImportData(s))return void await this.showErrorMessage("Invalid import file format. Please select a valid FastGPT extension export file.");if(!await this.confirmAction("Import Data",`This will replace all current data with the imported data. The import contains ${s.metadata?.totalSessions||0} chat sessions and ${s.metadata?.totalMessages||0} messages. Continue?`,!0))return;if(s.chatSessions&&!(await this.storageManager.setChatSessions(s.chatSessions)).success)throw new Error("Failed to import chat sessions");await this.loadOrCreateChatSession(),this.renderMessages(),console.log("Data imported successfully")}catch(e){console.error("Error importing data:",e),await this.showErrorMessage("Failed to import data. Please check the file format and try again.")}},e.click()}catch(e){console.error("Error setting up import:",e),await this.showErrorMessage("Failed to set up data import. Please try again.")}}async resetAllData(){try{(await this.stateManager.resetAllState()).success?(await this.stateManager.setCurrentView("onboarding"),window.dispatchEvent(new CustomEvent("viewChange"))):await this.showErrorMessage("Failed to reset all data. Please try again.")}catch(e){console.error("Error resetting all data:",e),await this.showErrorMessage("An error occurred while resetting all data.")}}validateImportData(e){try{if(!e||"object"!=typeof e)return!1;if(!e.version||!e.exportDate)return!1;if(e.chatSessions&&"object"==typeof e.chatSessions)for(const[t,s]of Object.entries(e.chatSessions)){const e=s;if(!e.messages||!Array.isArray(e.messages))return!1;if(!e.createdAt||!e.updatedAt)return!1}return!0}catch(e){return!1}}getTotalMessageCount(e){let t=0;if(e&&"object"==typeof e)for(const s of Object.values(e)){const e=s;e.messages&&Array.isArray(e.messages)&&(t+=e.messages.length)}return t}}class i{constructor(){this.appContainer=null,this.stateManager=new s,this.onboardingComponent=new n(this.stateManager),this.configurationComponent=new r(this.stateManager),this.chatComponent=new o(this.stateManager),this.setupEventListeners()}async initialize(){if(this.appContainer=document.getElementById("app"),this.appContainer)try{const e=await this.stateManager.initialize();if(!e.success)return console.error("Failed to initialize state:",e.error),void this.showError("Failed to initialize extension state");await this.renderCurrentView()}catch(e){console.error("Error initializing popup:",e),this.showError("An error occurred while loading the extension")}else console.error("App container not found")}async renderCurrentView(){if(!this.appContainer)return;const e=this.stateManager.getCurrentView();this.appContainer.classList.add("view-transitioning");try{switch(e){case"onboarding":default:await this.renderOnboardingView();break;case"configuration":await this.renderConfigurationView();break;case"chat":await this.renderChatView()}}finally{setTimeout(()=>{this.appContainer?.classList.remove("view-transitioning")},300)}}async renderOnboardingView(){console.log("Rendering onboarding view"),this.appContainer&&(await this.onboardingComponent.render(this.appContainer),console.log("Onboarding view rendered"))}async renderConfigurationView(){console.log("Rendering configuration view"),this.appContainer&&(await this.configurationComponent.render(this.appContainer),console.log("Configuration view rendered"))}async renderChatView(){console.log("Rendering chat view"),this.appContainer&&(await this.chatComponent.render(this.appContainer),console.log("Chat view rendered"))}showError(e){if(!this.appContainer)return;this.appContainer.innerHTML=`\n            <div class="error-container">\n                <div class="error-icon">⚠️</div>\n                <h3>Error</h3>\n                <p>${e}</p>\n                <button id="retry-button" class="nav-button primary">\n                    Retry\n                </button>\n            </div>\n        `;const t=this.appContainer.querySelector("#retry-button");t&&t.addEventListener("click",()=>{this.initialize()})}setupEventListeners(){window.addEventListener("onboardingComplete",async()=>{await this.renderCurrentView()}),window.addEventListener("viewChange",async e=>{await this.renderCurrentView()});let e=null;this.stateManager.addStateChangeListener(async t=>{console.log("State changed:",t);const s=this.stateManager.getCurrentView();s!==e&&(e=s,await this.renderCurrentView())})}}console.log("FastGPT Extension script loaded!"),document.addEventListener("DOMContentLoaded",()=>{console.log("DOM loaded, initializing popup app"),(new i).initialize()}),console.log("Script executing immediately")})();